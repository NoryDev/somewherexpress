<!-- START FINAL RANKING -->
<div id="track-<%= @competition.tracks.first.id %>-result">
  <!-- EDIT RESULTS -->
  <% if policy(@competition).update? %>
    <div class="btn-group pull-right">
      <button type="button" class="btn btn-grey dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <i class="fa fa-cog"></i> <span class="caret"></span>
      </button>
      <ul class="dropdown-menu">
        <li><%= link_to "#{t('competitions.edit_results')}", edit_competition_track_path(@competition, @competition.tracks.first) %></li>
      </ul>
    </div>
  <% end %>
  <!-- END EDIT RESULTS -->
  <h2>Final Ranking</h2>

  <table class="table">
    <tbody>
      <% (@competition.ranks.where.not(result: 0).order(:dsq, :result) + @competition.ranks.where(result: 0)).each_slice(2).to_a.each do |rank1, rank2| %>
        <tr>
          <td>
            <%= link_to rank1.user do %>
              <%= image_tag rank1.user.avatar, class: "avatar", alt: "#{rank1.user.first_name}" %>
            <% end %>
          </td>
          <td class="text-uppercase"><%= link_to rank1.user, rank1.user %></td>
          <td class="text-center"><%= result(rank1) %></td>
          <% if rank2 %>
            <td class="text-right text-uppercase"><%= link_to rank2.user, rank2.user %></td>
            <td class="text-right">
              <%= link_to rank2.user do %>
                <%= image_tag rank2.user.avatar, class: "avatar", alt: "#{rank2.user.first_name}" %>
              <% end %>
            </td>
          <% else %>
            <td></td>
            <td></td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
<!-- END FINAL RANKING -->

<% content_for(:after_js) do %>
  <%= javascript_tag do %>
    $(document).on( 'ready', function() {

      var directionsDisplay = new google.maps.DirectionsRenderer();
      var directionsService = new google.maps.DirectionsService();

      function calcRoute() {
        var origin      = new google.maps.LatLng(<%= @competition.start_location_lat %>, <%= @competition.start_location_lng %>);
        var destination = new google.maps.LatLng(<%= @competition.end_location_lat %>, <%= @competition.end_location_lng %>);
        var request = {
            origin:      origin,
            destination: destination,
            travelMode:  google.maps.TravelMode.DRIVING
        };
        directionsService.route(request, function(response, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            directionsDisplay.setDirections(response);
          }
        });
      }
      calcRoute();

      handler = Gmaps.build('Google');
      handler.buildMap({
      provider: {
        disableDefaultUI: true,
        styles: [{"featureType":"water","elementType":"geometry","stylers":[{"color":"#e9e9e9"},{"lightness":17}]},{"featureType":"landscape","elementType":"geometry","stylers":[{"color":"#f5f5f5"},{"lightness":20}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#ffffff"},{"lightness":17}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"color":"#ffffff"},{"lightness":29},{"weight":0.2}]},{"featureType":"road.arterial","elementType":"geometry","stylers":[{"color":"#ffffff"},{"lightness":18}]},{"featureType":"road.local","elementType":"geometry","stylers":[{"color":"#ffffff"},{"lightness":16}]},{"featureType":"poi","elementType":"geometry","stylers":[{"color":"#f5f5f5"},{"lightness":21}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#dedede"},{"lightness":21}]},{"elementType":"labels.text.stroke","stylers":[{"visibility":"on"},{"color":"#ffffff"},{"lightness":16}]},{"elementType":"labels.text.fill","stylers":[{"saturation":36},{"color":"#333333"},{"lightness":40}]},{"elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"geometry","stylers":[{"color":"#f2f2f2"},{"lightness":19}]},{"featureType":"administrative","elementType":"geometry.fill","stylers":[{"color":"#fefefe"},{"lightness":20}]},{"featureType":"administrative","elementType":"geometry.stroke","stylers":[{"color":"#fefefe"},{"lightness":17},{"weight":1.2}]}]
      },
      internal: { id: 'map' } }, function(){
        directionsDisplay.setMap(handler.getMap());
      });
    });
  <% end %>
<% end %>
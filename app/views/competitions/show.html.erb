<div class="container">
  <div class="row">
    <div class="col-xs-12 col-md-8 col-md-offset-2">
      <!-- START DESCRIPTION -->
      <h1><%= @competition %></h1>

      <table class="table">
        <tbody>
          <tr>
            <td><%= date_format(@competition.start_date) %> - <%= date_format(@competition.end_date) %></td>
            <td><%= @competition.start_location %> - <%= @competition.end_location %></td>
            <td>
              <% @competition.users.each do |user| %>
                <%= link_to user do %>
                  <%= image_tag user.avatar, class: "avatar", data: {toggle: "tooltip", placement: "bottom"}, title: "#{user}" %>
                <% end %>
              <% end %>
            </td>
          </tr>
        </tbody>
      </table>
      <!-- END DESCRIPTION -->

      <div id="map" style="width: 100%; height: 400px;"></div>

      <!-- START FINAL RANKING -->
      <h2>Final Ranking</h2>
      <table class="table">
        <tbody>
          <% @competition.ranks.order(:result).each do |rank| %>
            <tr>
              <td><%= rank.result %></td>
              <td>
                <%= link_to rank.user do %>
                  <%= image_tag rank.user.avatar, class: "avatar" %>
                <% end %>
              </td>
              <td><%= link_to rank.user, rank.user %></td>
              <td><%= rank.points %> points</td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <!-- END FINAL RANKING -->

      <!-- START STAGE RANKING -->
      <% if @competition.tracks.size > 1 %>
        <% @competition.tracks.order(:start_time).each_with_index do |track, i| %>
          <h3><%= i + 1 %>. <%= track.start_location %> - <%= track.end_location%></h3>
          <table class="table">
            <tbody>
              <% track.ranks.order(:result).each do |rank| %>
                <tr>
                  <td><%= rank.result %></td>
                  <td>
                    <%= link_to rank.user do %>
                      <%= image_tag rank.user.avatar, class: "avatar" %>
                    <% end %>
                  </td>
                  <td><%= link_to rank.user, rank.user %></td>
                  <td><%= rank.points %> points</td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
      <% end %>
      <!-- END STAGE RANKING -->
    </div>
  </div>
</div>

<% content_for(:after_js) do %>
  <%= javascript_tag do %>
    $(document).on( 'ready', function() {

      var directionsDisplay = new google.maps.DirectionsRenderer();
      var directionsService = new google.maps.DirectionsService();

      var waypts = [];
      <% if @competition.tracks.size > 1 %>
        <% @competition.tracks.each do |t| %>
          <% unless t.end_location == @competition.end_location %>
            waypts.push({
              location: '<%= t.end_location %>',
              stopover: true
            });
          <% end %>
        <% end %>
      <% end %>

      function calcRoute() {
        var origin      = new google.maps.LatLng(<%= @competition.start_location_lat %>, <%= @competition.start_location_lng %>);
        var destination = new google.maps.LatLng(<%= @competition.end_location_lat %>, <%= @competition.end_location_lng %>);
        var request = {
            origin:      origin,
            destination: destination,
            waypoints: waypts,
            travelMode:  google.maps.TravelMode.DRIVING
        };
        directionsService.route(request, function(response, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            directionsDisplay.setDirections(response);
          }
        });
      }
      calcRoute();

      handler = Gmaps.build('Google');
      handler.buildMap({
      provider: {
        disableDefaultUI: true,
        styles: [{"featureType":"water","elementType":"geometry","stylers":[{"color":"#e9e9e9"},{"lightness":17}]},{"featureType":"landscape","elementType":"geometry","stylers":[{"color":"#f5f5f5"},{"lightness":20}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#ffffff"},{"lightness":17}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"color":"#ffffff"},{"lightness":29},{"weight":0.2}]},{"featureType":"road.arterial","elementType":"geometry","stylers":[{"color":"#ffffff"},{"lightness":18}]},{"featureType":"road.local","elementType":"geometry","stylers":[{"color":"#ffffff"},{"lightness":16}]},{"featureType":"poi","elementType":"geometry","stylers":[{"color":"#f5f5f5"},{"lightness":21}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#dedede"},{"lightness":21}]},{"elementType":"labels.text.stroke","stylers":[{"visibility":"on"},{"color":"#ffffff"},{"lightness":16}]},{"elementType":"labels.text.fill","stylers":[{"saturation":36},{"color":"#333333"},{"lightness":40}]},{"elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"geometry","stylers":[{"color":"#f2f2f2"},{"lightness":19}]},{"featureType":"administrative","elementType":"geometry.fill","stylers":[{"color":"#fefefe"},{"lightness":20}]},{"featureType":"administrative","elementType":"geometry.stroke","stylers":[{"color":"#fefefe"},{"lightness":17},{"weight":1.2}]}]
      },
      internal: { id: 'map' } }, function(){
        directionsDisplay.setMap(handler.getMap());
      });
    });
  <% end %>
<% end %>
<!-- START FINAL RANKING -->
<div id="competition-<%= competition.id %>-result">
  <h2><%= t('competitions.show.final_ranking') %></h2>
  <table class="table bordered">
    <tbody>
      <%= render 'final_ranks', competition: competition %>
    </tbody>
  </table>
</div>
<!-- END FINAL RANKING -->

<!-- START STAGE RANKING -->
<% competition.tracks.order(:start_time).each_with_index do |track, i| %>
  <div id="track-<%= track.id %>-result">
    <h3>
      <%= i + 1 %>. <%= track %>
      <!-- EDIT RESULTS -->
      <% if policy(competition).update? %>
        <small><%= link_to t('competitions.edit_results'), edit_competition_track_path(competition, track) %></small>
      <% end %>
      <!-- END EDIT RESULTS -->
    </h3>
    <table class="table bordered">
      <tbody>
        <% (track.ranks.where.not(result: 0).order(:dsq, :result) + track.ranks.where(result: 0)).each do |rank| %>
          <tr>
            <td class="text-center"><%= track_result(rank) %></td>
            <td class="text-center">
              <%= render 'users/avatar_small', user: rank.user %>
            </td>
            <td class="text-uppercase"><%= link_to rank.user, rank.user %></td>
            <td class="text-right text-uppercase"><%= rank.points %> <%= t('ranks.params.points') %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>
<!-- END STAGE RANKING -->

<% content_for(:after_js) do %>
  <%= javascript_tag do %>
    $(document).on( 'ready', function() {

      var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});
      var directionsService = new google.maps.DirectionsService();

      var waypts = [];
      <% competition.tracks.order(:start_time).each do |t| %>
        <% unless t.end_location == competition.end_location %>
          waypts.push({
            location: '<%= t.end_location %>',
            stopover: true
          });
        <% end %>
      <% end %>

      function calcRoute() {
        var origin      = new google.maps.LatLng(<%= competition.start_location_lat %>, <%= competition.start_location_lng %>);
        var destination = new google.maps.LatLng(<%= competition.end_location_lat %>, <%= competition.end_location_lng %>);
        var request = {
            origin:      origin,
            destination: destination,
            waypoints:   waypts,
            travelMode:  google.maps.TravelMode.DRIVING
        };
        directionsService.route(request, function(response, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            directionsDisplay.setDirections(response);
          }
        });
      }
      calcRoute();

      handler = Gmaps.build('Google', { markers: { clusterer: undefined  }});
      handler.buildMap({
      provider: {
        disableDefaultUI: true,
        zoomControl: true,
        scrollwheel: false,
        styles: [{"featureType":"water","elementType":"geometry","stylers":[{"color":"#e9e9e9"},{"lightness":17}]},{"featureType":"landscape","elementType":"geometry","stylers":[{"color":"#f5f5f5"},{"lightness":20}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#ffffff"},{"lightness":17}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"color":"#ffffff"},{"lightness":29},{"weight":0.2}]},{"featureType":"road.arterial","elementType":"geometry","stylers":[{"color":"#ffffff"},{"lightness":18}]},{"featureType":"road.local","elementType":"geometry","stylers":[{"color":"#ffffff"},{"lightness":16}]},{"featureType":"poi","elementType":"geometry","stylers":[{"color":"#f5f5f5"},{"lightness":21}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#dedede"},{"lightness":21}]},{"elementType":"labels.text.stroke","stylers":[{"visibility":"on"},{"color":"#ffffff"},{"lightness":16}]},{"elementType":"labels.text.fill","stylers":[{"saturation":36},{"color":"#333333"},{"lightness":40}]},{"elementType":"labels.icon","stylers":[{"visibility":"on"}]},{"featureType": "road","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"geometry","stylers":[{"color":"#f2f2f2"},{"lightness":19}]},{"featureType":"administrative","elementType":"geometry.fill","stylers":[{"color":"#fefefe"},{"lightness":20}]},{"featureType":"administrative","elementType":"geometry.stroke","stylers":[{"color":"#fefefe"},{"lightness":17},{"weight":1.2}]}]
      },
      internal: { id: 'map' } }, function(){
        markers = handler.addMarkers([
          <% competition.tracks.order(:start_time).each do |t| %>
            <% unless t.end_location == competition.end_location %>
              {
                "lat": <%= t.end_location_lat %>,
                "lng": <%= t.end_location_lng %>,
                "picture": {
                  "url": "<%= image_url("marker.svg") %>",
                  "width":  32,
                  "height": 32}
              },
            <% end %>
          <% end %>

            {
              "lat": <%= competition.start_location_lat %>,
              "lng": <%= competition.start_location_lng %>,
              "picture": {
                "url": "<%= image_url("marker.svg") %>",
                "width":  32,
                "height": 32}
            },
            {
              "lat": <%= competition.end_location_lat %>,
              "lng": <%= competition.end_location_lng %>,
              "picture": {
                "url": "<%= image_url("marker.svg") %>",
                "width":  32,
                "height": 32}
            }]


        );
        directionsDisplay.setMap(handler.getMap());
      });
    });
  <% end %>
<% end %>